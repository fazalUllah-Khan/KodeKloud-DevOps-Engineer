The Nautilus Application Development team is planning to deploy one of the php-based applications on Kubernetes cluster. As per the recent discussion with DevOps team, they have decided to use nginx and phpfpm. 
Additionally, they also shared some custom configuration requirements. Below you can find more details. Please complete this task as per requirements mentioned below:


      1) Create a service to expose this app, the service type must be NodePort, nodePort should be 30012.

      2.) Create a config map named nginx-config for nginx.conf as we want to add some custom settings in nginx.conf.

              a) Change the default port 80 to 8094 in nginx.conf.

              b) Change the default document root /usr/share/nginx to /var/www/html in nginx.conf.

              c) Update the directory index to index index.html index.htm index.php in nginx.conf.

      3.) Create: 
              a) a pod named nginx-phpfpm .

              b) Create a shared volume named shared-files that will be used by both containers (nginx and phpfpm) also it should be a emptyDir volume.

              c) Map the ConfigMap we declared above as a volume for nginx container. Name the volume as nginx-config-volume, mount path should be /etc/nginx/nginx.conf and subPath should be nginx.conf

              d) Nginx container should be named as nginx-container and it should use nginx:latest image. PhpFPM container should be named as php-fpm-container and it should use php:7.4-fpm-alpine image.

              e) The shared volume shared-files should be mounted at /var/www/html location in both containers. Copy /opt/index.php from jump host to the nginx document root inside the nginx container, 
                 once done you can access the app using App button on the top bar.

Before clicking on finish button always make sure to check if all pods are in running state.

You can use any labels as per your choice.

Note: The kubectl utility on jump_host has been configured to work with the kubernetes cluster.

************************************* SOLUTION ***********************************************
Last login: Thu Apr 11 22:47:54 UTC 2024 on pts/0
thor@jump_host ~$ ls -l
total 0
thor@jump_host ~$ kubctl get all
bash: kubctl: command not found
thor@jump_host ~$ kubectl get all
NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   129m
thor@jump_host ~$ vi /tmp/nginx-phpfpm.yml
thor@jump_host ~$ cat /tmp/nginx-phpfpm.yml

---       
apiVersion: v1
kind: Service
metadata:
  name: nginx-phpfpm
spec:
  type: NodePort
  selector:
    app: nginx-phpfpm
    tier: back-end
  ports:
    - port: 8094
      targetPort: 8094
      nodePort: 30012

---

apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
data:
  nginx.conf: |
    events {} 
    http {
      server {
        listen 8094;
        index index.html index.htm index.php;
        root  /var/www/html;
        location ~ \.php$ {
          include fastcgi_params;
          fastcgi_param REQUEST_METHOD $request_method;
          fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
          fastcgi_pass 127.0.0.1:9000;
        }
      }
    }

---
       
apiVersion: v1
kind: Pod
metadata:
  name: nginx-phpfpm
  labels:
     app: nginx-phpfpm
     tier: back-end
spec:
  volumes:
    - name: shared-files
      emptyDir: {}
    - name: nginx-config-volume
      configMap:
        name: nginx-config
  containers:
    - name: nginx-container
      image: nginx:latest
      volumeMounts:
        - name: shared-files
          mountPath: /var/www/html
        - name: nginx-config-volume
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
    - name: php-fpm-container
      image: php:7.4-fpm-alpine
      volumeMounts:
        - name: shared-files
          mountPath: /var/www/html  
thor@jump_host ~$ kubectl create -f /tmp/nginx-phpfpm.yml
service/nginx-phpfpm created
configmap/nginx-config created
pod/nginx-phpfpm created
thor@jump_host ~$ kubectl get po
NAME           READY   STATUS              RESTARTS   AGE
nginx-phpfpm   0/2     ContainerCreating   0          13s
thor@jump_host ~$ kubectl get po
NAME           READY   STATUS    RESTARTS   AGE
nginx-phpfpm   2/2     Running   0          17s
thor@jump_host ~$ kubectl get svc
NAME           TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE
kubernetes     ClusterIP   10.96.0.1      <none>        443/TCP          136m
nginx-phpfpm   NodePort    10.96.97.172   <none>        8094:30012/TCP   21s
thor@jump_host ~$ kubectl get cm
NAME               DATA   AGE
kube-root-ca.crt   1      135m
nginx-config       1      29s
thor@jump_host ~$ cat /opt/index.php
It works!thor@jump_host ~$ 
thor@jump_host ~$ kubectl cp /opt/index.php nginx-phpfpm:/var/www/html/ -c nginx-container
thor@jump_host ~$ kubectl -it nginx-phpfpm -c nginx-container -- ls -la /var/www/html
Error: flags cannot be placed before plugin name: -it
thor@jump_host ~$ kubectl exec -it nginx-phpfpm -c nginx-container -- ls -la /var/www/html
total 12
drwxrwxrwx 2 root root 4096 Apr 11 23:13 .
drwxr-xr-x 3 root root 4096 Apr 11 23:12 ..
-rw-r--r-- 1 root root    9 Apr 11 23:13 index.php


*************************************** VERIFICATION **************************************************
thor@jump_host ~$ kubectl exec -it nginx-phpfpm -c nginx-container -- cat /var/www/html/index.php
It works!thor@jump_host ~$ 
thor@jump_host ~$ kubectl exec -it nginx-phpfpm -c nginx-container -- curl -I http://localhost:8094
HTTP/1.1 200 OK
Server: nginx/1.25.4
Date: Thu, 11 Apr 2024 23:15:57 GMT
Content-Type: text/html; charset=UTF-8
Connection: keep-alive
X-Powered-By: PHP/7.4.33

thor@jump_host ~$ kubectl exec -it nginx-phpfpm -c nginx-container -- curl http://localhost:8094
It works!thor@jump_host ~$ 
thor@jump_host ~$

Click on "App Button" on right cornor of task window. This will open https://30012-port-8aa8f786bd3f48de.labs.kodekloud.com/ in new tabe with Message ""It works!"". ---> SUCCESSFUL 
